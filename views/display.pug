doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title Your Appointments
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css")
    style.
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #141E30, #243B55); /* smooth dark gradient */
        color: #fff;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
      }
      .container {
        max-width: 1000px;
        margin: auto;
        background: rgba(255, 255, 255, 0.08); /* subtle glass effect */
        backdrop-filter: blur(12px);
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      }
      h2 {
        text-align: center;
        margin-bottom: 25px;
        font-weight: 600;
        letter-spacing: 1px;
      }
      .scrollable-container {
        max-height: 350px;
        overflow-y: auto;
      }
      .table th, .table td {
        vertical-align: middle;
        text-align: center;
      }
      .status {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 5px;
        display: inline-block;
      }
      .status.pending { background: #f1c40f; color: #000; }
      .status.confirmed { background: #2ecc71; color: #fff; }
      .status.cancelled { background: #e74c3c; color: #fff; }
      #appointmentSearch {
        max-width: 400px;
        margin: 15px auto;
      }

  body
    .container
      h2 Your Appointments

      input#appointmentSearch.form-control.mb-3(type="text", placeholder="Search by business name or mobile number")

      .accordion#appointmentAccordion
        each section in ['Current', 'Upcoming', 'Past']
          .accordion-item
            h2.accordion-header
              button.accordion-button.collapsed(
                type="button", 
                data-bs-toggle="collapse", 
                data-bs-target=`#collapse${section}`
              )
                | #{section} Appointments
            div.accordion-collapse.collapse(id=`collapse${section}`, data-bs-parent="#appointmentAccordion")
              .accordion-body
                .scrollable-container
                  table.table.table-bordered.table-striped
                    thead
                      tr
                        th Scheduler
                        th Scheduled With
                        th Address
                        th Contact
                        th Date
                        th Time
                        th Status
                    tbody(id=`${section.toLowerCase()}-appointments`)

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js")

    // Client-side JS
    script.
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          const res = await fetch('/user/appointments-overview');
          const data = await res.json();

          renderAppointments(data.currentAppointments, 'current-appointments');
          renderAppointments(data.upcomingAppointments, 'upcoming-appointments');
          renderAppointments(data.pastAppointments, 'past-appointments');
        } catch (err) {
          console.error('Failed to fetch appointments:', err);
        }
      });

      function renderAppointments(appointments, tableId) {
        console.log('appointments is:', appointments);
        const tbody = document.getElementById(tableId);
        tbody.innerHTML = '';
        if (!appointments || !appointments.length) {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="6">No appointments found</td>`;
          tbody.appendChild(row);
          return;
        }

        appointments.forEach(app => {
          const row = document.createElement('tr');
          const statusClass = app.status ? app.status.toLowerCase() : 'pending';
          const appointmentDate = new Date(app.appointmentDate);
          const formattedDate = appointmentDate.toLocaleDateString('en-IN');
          row.innerHTML = `
            <td>${app.name || '-'}</td>
            <td>${app.adminDetails?.username || '-'}</td>
            <td>${app.adminDetails?.corporateAdress || '-'}</td>
            <td>${app.adminDetails?.mobile || '-'}</td>
            <td>${formattedDate}</td>
            <td>${app.appointmentTime}</td>
            <td class="status ${statusClass}">${app.status || 'Pending'}</td>
          `;
          tbody.appendChild(row);
        });
      }

    // Search filter
    script.
        document.getElementById('appointmentSearch').addEventListener('input', function() {
            const val = this.value.toLowerCase().trim();

            ['current-appointments','upcoming-appointments','past-appointments'].forEach(id => {
            let anyVisible = false;
            document.querySelectorAll(`#${id} tr`).forEach(row => {
                const rowText = row.textContent.toLowerCase();
                const match = rowText.includes(val);
                row.style.display = match ? '' : 'none';
                if (match) anyVisible = true;
            });

            // Expand accordion section if matches exist
            const collapseDiv = document.querySelector(`#${id}`).closest('.accordion-collapse');
            const button = collapseDiv.previousElementSibling.querySelector('.accordion-button');
            if (anyVisible && !collapseDiv.classList.contains('show')) {
                new bootstrap.Collapse(collapseDiv, { show: true });
                button.classList.remove('collapsed');
            }
            });
        });
